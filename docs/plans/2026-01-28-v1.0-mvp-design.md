# v1.0 MVP Design

**Date**: 2026-01-28
**Target**: Power users comfortable with CLI
**Goal**: Production-ready mod manager with NexusMods + local import, automatic dependencies, hooks, conflict detection, and Steam auto-detection.

---

## Scope Summary

### Already Complete (v0.7.8)

- NexusMods search, download, install (multi-file support)
- Update management with policies (auto/notify/pinned) + rollback
- Profile system (create, switch, export, import, sync, apply)
- Deployment strategies (symlink, hardlink, copy)
- Enable/disable mods, purge, deploy commands
- Per-game config (link method, cache path)
- File ID tracking for re-downloads
- Deployed vs enabled state tracking

### New Features for v1.0

| Feature                  | Effort     | Priority |
| ------------------------ | ---------- | -------- |
| Local mod import         | Medium     | High     |
| Auto dependency install  | Medium     | High     |
| Installation hooks       | Low-Medium | High     |
| Conflict detection       | Medium     | Medium   |
| Steam auto-detection     | Low        | Medium   |
| Checksum verification    | Low        | Medium   |
| `--json` output flag     | Low        | Medium   |
| Production test coverage | High       | High     |
| Man pages + docs         | Medium     | High     |

---

## Feature Designs

### 1. Local Mod Import

**Purpose**: Allow users to install mods from local archive files downloaded manually.

**Commands**:

```bash
# Import a single mod archive
lmm import /path/to/mod.zip --game skyrim-se

# Import with metadata (if known)
lmm import /path/to/mod.7z --game skyrim-se --id 12345 --source nexusmods
```

**Behavior**:

1. **Archive detection**: Support same formats as install (zip, 7z, rar)
2. **NexusMods matching**: Parse filename for patterns like `ModName-ModID-Version.zip` and auto-link for update tracking
3. **Manual metadata**: Allow specifying `--id` and `--source` for update tracking
4. **Unknown mods**: If source can't be determined, track as "local" source with no update checking

**Data Model Changes**:

- Add `local` as a valid source type
- Store original file path for local mods (for update detection via file modification time)

**Code Location**: New `cmd/lmm/import.go` command, extend `internal/core/installer.go`

---

### 2. Automatic Dependency Installation

**Purpose**: When installing a mod, automatically install its required dependencies.

**Behavior**:

```bash
lmm install "skyui" --game skyrim-se

# Output:
# Resolving dependencies for SkyUI (12345)...
# Required dependencies:
#   - SKSE64 (30379) [not installed]
#   - Address Library (32444) [installed]
#
# Install 1 missing dependency? [Y/n]
```

**Flow**:

1. Fetch mod from NexusMods
2. Call `GetDependencies()` to get required mods
3. Check which are already installed
4. For missing deps, recursively resolve their dependencies (with cycle detection)
5. Present full install list in topological order (deps first)
6. Prompt for confirmation
7. Install in order: dependencies → target mod

**Flags**:

- `--no-deps` - Skip dependency installation
- `-y` / `--yes` - Auto-confirm dependency installation

**Edge Cases**:

- **Circular dependencies**: Use existing cycle detection - fail with clear error
- **Dependency not on NexusMods**: Warn and continue
- **Version requirements**: NexusMods doesn't provide version constraints, install latest

**Code Location**: Extend `internal/core/installer.go` with dependency resolution

---

### 3. Installation Hooks

**Purpose**: Run user-defined scripts at key points during mod operations.

**Hook Points**:
| Hook | When it runs | Use case |
|------|--------------|----------|
| `pre-install` | Before any mod is installed | Backup, close game |
| `post-install` | After each mod is installed | Run FNIS, LOOT sort |
| `pre-uninstall` | Before mod is removed | Cleanup scripts |
| `post-uninstall` | After mod is removed | Regenerate load order |
| `post-deploy` | After deploy/redeploy completes | Final validation |

**Configuration** (`games.yaml`):

```yaml
games:
  skyrim-se:
    name: "Skyrim Special Edition"
    install_path: "/path/to/skyrim"
    mod_path: "/path/to/skyrim/Data"
    sources:
      nexusmods: "skyrimspecialedition"
    hooks:
      post-install: ~/.config/lmm/hooks/skyrim-post-install.sh
      post-deploy: ~/.config/lmm/hooks/skyrim-loot-sort.sh
```

**Environment Variables** (passed to scripts):

- `LMM_GAME_ID` - Game identifier
- `LMM_GAME_PATH` - Game install path
- `LMM_MOD_PATH` - Mod deployment path
- `LMM_MOD_ID` - Mod being installed (for per-mod hooks)
- `LMM_MOD_NAME` - Mod name
- `LMM_MOD_VERSION` - Mod version
- `LMM_HOOK` - Which hook is running

**Behavior**:

- Scripts must be executable
- Non-zero exit code aborts the operation (with `--force` to override)
- Timeout after 60 seconds (configurable)
- stdout/stderr shown to user

**Code Location**: New `internal/core/hooks.go`

---

### 4. Conflict Detection

**Purpose**: Warn users when installing a mod that overwrites files from an existing mod.

**Behavior**:

```bash
lmm install "unofficial patch" --game skyrim-se

# Output:
# Analyzing files...
# ⚠ File conflicts detected:
#   - Data/meshes/actors/character/facegen.nif
#     Currently from: RaceMenu (123)
#     Will be overwritten by: Unofficial Patch (456)
#
# 2 files will be overwritten. Continue? [y/N]
```

**Implementation**:

1. **Track deployed files**: New DB table

   ```sql
   CREATE TABLE deployed_files (
     game_id TEXT,
     profile_name TEXT,
     relative_path TEXT,
     source_id TEXT,
     mod_id TEXT,
     deployed_at DATETIME,
     PRIMARY KEY (game_id, profile_name, relative_path)
   );
   ```

2. **On install**: Before deploying, query which files already exist and from which mod

3. **On uninstall**: Remove entries from `deployed_files`

**Flags**:

- `--force` - Install without conflict prompts

**New Commands**:

```bash
lmm mod files <mod-id> --game skyrim-se  # See what files a mod owns
lmm conflicts --game skyrim-se            # See all conflicts in profile
```

**Code Location**: New `internal/storage/db/files.go`, extend installer

---

### 5. Steam Game Auto-Detection

**Purpose**: Automatically find installed Steam games and their paths.

**Command**:

```bash
lmm game detect

# Output:
# Scanning Steam libraries...
# Found 3 moddable games:
#   1. Skyrim Special Edition (489830)
#      Path: ~/.steam/steam/steamapps/common/Skyrim Special Edition
#   2. Starfield (1716740)
#      Path: ~/.steam/steam/steamapps/common/Starfield
#
# Add games to config? [1,2/all/none]: 1,2
```

**Implementation**:

1. **Find Steam root**: Check `~/.steam/steam/`, `~/.local/share/Steam/`, `$STEAM_ROOT`

2. **Parse library folders**: Read `steamapps/libraryfolders.vdf`

3. **Scan for games**: Parse `appmanifest_*.acf` files

4. **Match to known games**: Map Steam App IDs to NexusMods game slugs

**Known Games Database** (`internal/source/steam/games.go`):

```go
var KnownGames = map[string]GameInfo{
    "489830":  {Slug: "skyrim-se", NexusID: "skyrimspecialedition", ModPath: "Data"},
    "1716740": {Slug: "starfield", NexusID: "starfield", ModPath: "Data"},
    // ... 10-20 popular moddable games
}
```

**Code Location**: New `internal/source/steam/` package, new `cmd/lmm/game_detect.go`

---

### 6. Checksum Verification

**Purpose**: Verify downloaded files match NexusMods checksums.

**Behavior**:

```bash
lmm install "skyui" --game skyrim-se

# Downloading SkyUI-12345-5.2.zip (2.3 MB)...
# [████████████████████████████████] 100%
# Verifying checksum... ✓ OK
```

**Implementation**:

1. Fetch MD5 checksum from NexusMods REST API
2. Verify after download, before extraction
3. Retry on failure (up to 3 attempts)
4. Store verified checksum in DB

**New Command**:

```bash
lmm verify --game skyrim-se       # Verify cached mods
lmm verify --fix --game skyrim-se # Re-download corrupted files
```

**Flags**:

- `--skip-verify` - Skip checksum verification on install

**Code Location**: Extend `internal/core/downloader.go`, new `cmd/lmm/verify.go`

---

### 7. Production Quality

#### Testing Requirements

| Layer   | Coverage Target | Approach                    |
| ------- | --------------- | --------------------------- |
| Domain  | 90%+            | Pure unit tests             |
| Storage | 85%+            | In-memory SQLite, temp dirs |
| Core    | 80%+            | Mock sources/storage        |
| Source  | 75%+            | Recorded HTTP responses     |
| CLI     | Key paths       | End-to-end tests            |

#### Documentation

1. **Man pages** - `lmm(1)`, `lmm-install(1)`, etc.
2. **Configuration reference** - All config.yaml and games.yaml options
3. **CONTRIBUTING.md** - Contribution guidelines

#### CLI Polish

- Consistent error messages with actionable hints
- `--json` flag on list/status/search for scripting
- Color output with `--no-color` and `NO_COLOR` support
- Exit codes: 0=success, 1=error, 2=user cancelled

---

## Implementation Order

Recommended sequence based on dependencies:

1. **Checksum verification** - Low risk, foundational
2. **Conflict detection** - Requires DB migration, used by later features
3. **Local mod import** - Builds on existing install flow
4. **Auto dependencies** - Extends install, needs conflict detection
5. **Installation hooks** - Independent, can parallelize
6. **Steam auto-detection** - Independent, can parallelize
7. **Production quality** - Ongoing throughout, final push at end

---

## Version Milestone

When all features are complete and tested:

- Bump version to `1.0.0`
- Update CHANGELOG.md with full release notes
- Tag release and publish to GitHub Releases
